---
title: "SWAMP Field Measure Verification"
author: "Marc Petta"
date: "January 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### SWAMP Field Measurements and Physical Habitat Template Verification Automation
The SWAMP Field Measurements and Physical Habitat template often requires modification upon reciept. For loading, ensure that the Funding Code worksheet has been added (position sheet = 6) and has appropriate field names. As of November 2018 the current SWAMP Field Loader only accepts xls files; save file format accordingly for loading. 

##For using this script ensure the file is saved as xlsx.

ASSUMPTIONS:
What follows assumes that xlsx formatting matches what is generated by the Extraction Tool; assumes all constituents are fixed as of November 2018 and that each analyte has only one unit of measurement; treats all projects equally and consideration should be made whether to apply this to non swamp data.

All ranges determination research was validated by ranges apperent in swamp histroic data; 2017 and before.


Please note that this verifies common field measuremets submitted to swamp. New constituents/anlaytes need to be added here when they develop. If the file read here has uncommon or new constituents they will need to be reviewed manually.

```{r}
##########  112118-this code works. Still need to work on converting operations #########

library(dplyr)
library(readxl)
library(writexl)

```

## SWAMP
Whats follows is an automoation of the SWAMP Field Measure Verification method.


```{r}
#Save SWAMP Field Measures and Physical Habitat template to working directory

#Read in the file that is to be verified.
swamp = read_excel("swamp.xlsx", 
                   sheet = "HabitatResults",
                   col_types = c("text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "text", "text", "text", "text", "text", "text", "text", "numeric", "text", "text", "text", "text", "text", "text"))

#Transform col types as date time 
mutate(swamp, SampleDate= as.Date(SampleDate, format= "%d.%m.%Y"))
mutate(swamp, CollectionTime= as.Date(CollectionTime, format= "%H:%M:%S"))


#Review to ensure the data frame has the appropriate headers and formatted correctly.
head(swamp)
```

```{r}

```
##Verification

```{r}
###NEED TO CONVERT ALL THESE COMMENTED OUT STATEMENTS FROM CASEWHEN TO IFELSE BECASUE R DOES NOT LIKE THE OPERATIONS I HAVE CURRENTLY###

swamp <-
  swamp %>%
  mutate(ComplianceCode = case_when( 
    AnalyteName == "Algae-attached" & Result < 0 ~ "QAORR",
    AnalyteName == "Algae-attached" & Result > 100 ~ "QAORR",
   # AnalyteName == "AssemblageIDAlgaeSampleVolume" & Result != 45 ~ "QAORR",
    #AnalyteName == "AssemblageIDDiatomSampleVolume" & Result != 45 ~ "QAORR",
    #AnalyteName == "AssemblageIDDiatomSampleVolume" & Result != 40 ~ "QAORR",
    #AnalyteName == "Bank Stability" & VariableResult != ("stable" | "vulnerable" | "eroded" | "Not Recorded") ~ "QAORR",
    #AnalyteName == "Bankfull Height" GROUP by StationCode - IF "result" is > standard deviation of "Location Code A - K
    #AnalyteName == "Bankfull Width" GROUP by StationCode - IF "result" is > standard deviation of "Location Code A - K
    AnalyteName == "Bearing" & Result < 0 ~ "QAORR",
    AnalyteName == "Bearing" & Result > 360 ~ "QAORR",
    AnalyteName == "BeaufortScale" & Result < 0 ~ "QAORR",
    AnalyteName == "BeaufortScale" & Result > 5 ~ "QAORR",
    #AnalyteName == "BeaufortScale" & Result == "Not Recorded" ~ "Com",
    AnalyteName == "BiomassSampleVolume" & Result < 0 ~ "QAORR",
    AnalyteName == "BiomassSampleVolume" & Result > 25 ~ "QAORR",
    AnalyteName == "Canopy Cover" & Result < 0 ~ "QAORR",
    AnalyteName == "Canopy Cover" & Result > 17 ~ "QAORR",
    AnalyteName == "Cascade/Falls" & Result < 0 ~ "QAORR",
    AnalyteName == "Cascade/Falls" & Result > 100 ~ "QAORR",
    #AnalyteName == "Channel Engineered" & VariableResult != ("YES" | "NO") ~ "QAORR",
    AnalyteName == "ChlorophyllSampleVolume" & Result < 0 ~ "QAORR",
    AnalyteName == "ChlorophyllSampleVolume" & Result > 150 ~ "QAORR",
    AnalyteName == "CompositeVolume" & Result < 0 ~ "QAORR",
    AnalyteName == "CompositeVolume" & Result > 1250 ~ "QAORR",
    #AnalyteName == "CPOM" & VariableResult != ("Present" | "Dry" |"Absent" | "Not Recorded") ~ "QAORR",
    AnalyteName == "CSCI" & Result < 0 ~ "QAORR",
    AnalyteName == "CSCI" & Result > 2 ~ "QAORR",
    AnalyteName == "CSCI_Percentile" & Result < 0 ~ "QAORR",
    AnalyteName == "CSCI_Percentile" & Result > 1 ~ "QAORR",
    AnalyteName == "Distance from Bank" & Result < 0 ~ "QAORR",
    AnalyteName == "Distance from Bank" & UnitName == "m" & Result > 35 ~ "QAORR",
    AnalyteName == "Distance from Bank" & UnitName == "cm" & Result > 16000 ~ "QAORR",
    AnalyteName == "Distance, Float" & Result < 0 ~ "QAORR",
    AnalyteName == "Distance, Float" & Result > 15 ~ "QAORR",
    #AnalyteName == "Dominant Land Use" & VariableResult != ("Forest" | "Urban/Industrial" |"Agriculture" | "Suburban, Town" | "Range", "Other") ~ "QAORR",
    AnalyteName == "Dry" & Result < 0 ~ "QAORR",
    AnalyteName == "Dry" & Result > 15 ~ "QAORR",
    AnalyteName == "Elevation Difference" & Result < -20 ~ "QAORR",
    AnalyteName == "Elevation Difference" & Result > 300 ~ "QAORR",
    AnalyteName == "Embeddedness" & Result < 0 ~ "QAORR",
    AnalyteName == "Embeddedness" & Result > 100 ~ "QAORR",
    #AnalyteName == "Evidence of Scour" & VariableResult != ("YES" | "NO") ~ "QAORR",
    AnalyteName == "Float Time" & Result < 0 ~ "QAORR",
    AnalyteName == "Float Time" & Result > 100 ~ "QAORR",
    AnalyteName == "Gage Height" & Result < 0 ~ "QAORR",
    AnalyteName == "Gage Height" & Result > 30 ~ "QAORR",
    AnalyteName == "Glide" & Result < 0 ~ "QAORR",
    AnalyteName == "Glide" & Result > 100 ~ "QAORR",
    #AnalyteName == "Length Reach" & ProtocolCode == ("SWAMP_2016_WS" | "SWAMP_2007_WS" | "SWAMP_2007_WS_Basic") & Result != 150 ~ "QAORR",
    #AnalyteName == "Length Reach" & ProtocolCode == ("SWAMP_2016_WS" | "SWAMP_2007_WS" | "SWAMP_2007_WS_Basic") & Result != 250 ~ "QAORR",
    #AnalyteName == "Length, Segment" & ProtocolCode == ("SWAMP_2016_WS" | "SWAMP_2007_WS" | "SWAMP_2007_WS_Basic") & Result < 0 ~ "QAORR",
   #AnalyteName == "Length, Segment" & ProtocolCode == ("SWAMP_2016_WS" | "SWAMP_2007_WS" | "SWAMP_2007_WS_Basic") & Result > 25 ~ "QAORR",
    #AnalyteName == "Macroalgae Cover, Attached" & VariableResult != ("Present" | "Dry" |"Absent" | "Not Recorded") ~ "QAORR",
    #AnalyteName == "Macroalgae Cover, Unattached" & VariableResult != ("Present" | "Dry" |"Absent" | "Not Recorded") ~ "QAORR",
    #AnalyteName == "Macrophyte Cover" & VariableResult != ("Present" | "Dry" |"Absent" | "Not Recorded") ~ "QAORR",
    #AnalyteName == "ObservedChannelFlowLevel" & VariableResult != ("Low" | "High" |"Normal" | "Flood" | "Not Recorded") ~ "QAORR",
    AnalyteName == "Pool" & Result < 0 ~ "QAORR",
    AnalyteName == "Pool" & Result > 100 ~ "QAORR",
    AnalyteName == "Proportion" & Result < 0 ~ "QAORR",
    AnalyteName == "Proportion" & Result > 100 ~ "QAORR",
    AnalyteName == "Riffle" & Result < 0 ~ "QAORR",
    AnalyteName == "Riffle" & Result > 100 ~ "QAORR",
    AnalyteName == "Run" & Result < 0 ~ "QAORR",
    AnalyteName == "Run" & Result > 100 ~ "QAORR",
    AnalyteName == "Slope" & Result < -10 ~ "QAORR",
    AnalyteName == "Slope" & Result > 100 ~ "QAORR",
    AnalyteName == "StationWaterDepth" & Result < -10 ~ "QAORR",
    AnalyteName == "StationWaterDepth" & Result > 500 ~ "QAORR",
    ###SUBSTRATE SIZECLASS CODE NEEDS A DICT###
    
    
    #AnalyteName == "TransectsSampled" & Result != 11 ~ "QAORR",
    AnalyteName == "Vegetation Cover Instream" & Result < 0 ~ "QAORR",
    AnalyteName == "Vegetation Cover Instream" & Result > 100 ~ "QAORR",
    AnalyteName == "Velocity" & Result < 0 ~ "QAORR",
    AnalyteName == "Velocity" & Result > 3000 ~ "QAORR",
   
    TRUE ~ "Com"
  ))


  #looks at QACode and returns QAORR if value other than None
  #looks at BatchVerificationCode
  #looks at ResQualCode
swamp <-
  swamp %>%
  mutate(ComplianceCode = as.factor(ifelse(QACode == "None", ComplianceCode, "QAORR"))) %>%
  mutate(BatchVerificationCode = as.factor(ifelse(ComplianceCode == "Com", "NA", "NA" ))) %>%
  mutate(ResQualCode = as.character(ifelse(Result == "" &  VariableResult =="", "NR", ResQualCode)))


  #mutate(LeatherMod = as.factor(ifelse(Leather == 1, "Yes", "No")))
#View(swamp)
```

The output of the following is to be reviewed and imported into the final template for loading.
The result of this will require that all ComplianceCodes, ResQualCodes, and QACodes are finalized according to SWAMP business rules before loading.

```{r}

write_xlsx(swamp, "SWAMP_WrtiteTest.xlsx", col_names = TRUE)

```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
